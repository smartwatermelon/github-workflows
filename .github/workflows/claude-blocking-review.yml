name: Claude Blocking Code Review

# Reusable workflow: blocks PR merges when Claude finds bugs, reliability
# regressions, security issues, or data-loss risks.
#
# Usage in a caller workflow:
#
#   jobs:
#     claude-review:
#       uses: YOUR_ORG/github-workflows/.github/workflows/claude-blocking-review.yml@v1
#       with:
#         pr_number: ${{ github.event.pull_request.number }}
#         extra_instructions: |
#           Repo-specific guidance here.
#       secrets:
#         claude_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
#
# The calling job name ("claude-review" above) becomes the required status
# check name: "Claude Code Review / claude-review" in branch protection.
#
# Escape hatch: add [skip-claude-review: reason] to the PR body to bypass
# enforcement with an audit trail.

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number (pass github.event.pull_request.number)'
        type: number
        required: true
      extra_instructions:
        description: 'Repo-specific instructions appended to the base review prompt'
        type: string
        required: false
        default: ''
    secrets:
      claude_oauth_token:
        description: 'Claude Code OAuth token (CLAUDE_CODE_OAUTH_TOKEN secret)'
        required: true

jobs:
  run-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write  # required by claude-code-action for internal authentication

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        continue-on-error: true  # infrastructure failure must not block merges
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.claude_oauth_token }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ inputs.pr_number }}

            Please review this pull request and provide feedback on:
            - Code quality and best practices
            - Potential bugs or logic errors
            - Reliability regressions (something that used to work may now break)
            - Security concerns
            - Test coverage for changed behavior

            Use the repository's CLAUDE.md for guidance on style and conventions.
            Be constructive and specific — cite file names and line numbers where possible.
            When listing non-blocking observations, order them by maintenance impact:
            issues that will predictably cause test drift or duplicated bugs should
            appear before stylistic or organizational notes.

            ${{ inputs.extra_instructions != '' && format('---\n\nAdditional instructions for this repository:\n\n{0}', inputs.extra_instructions) || '' }}

            ---

            VERDICT INSTRUCTIONS — follow these exactly:

            Determine your verdict based on the review findings:

            Use VERDICT: BLOCK if ANY of the following are true:
            - You found a clear bug that causes incorrect behavior in production (wrong
              calculation, incorrect condition, off-by-one that affects real data)
            - You found a reliability regression: a previously working feature or pipeline
              path may now fail because of changes in this PR
            - You found a security vulnerability: hardcoded credentials, unvalidated user
              input reaching a privileged operation, or an auth check that can be bypassed
            - You found missing error handling on an async operation that would cause a
              silent failure or surface a raw exception to the user
            - You found a risk of data loss or data corruption

            Use VERDICT: PASS in all other cases, including:
            - Style and naming issues
            - Test coverage gaps that do not affect existing behavior
            - Performance concerns without measurable impact
            - Documentation gaps
            - Code organization suggestions
            - Informational warnings

            EVIDENCE STANDARD FOR RELIABILITY REGRESSION BLOCKs:

            You cannot run the test suite. When claiming a test will fail or a code
            path will regress, you must trace the execution path from entry point to
            the specific assertion or failure point, with line-number citations at each
            step. If your trace relies on assumed execution order you have not verified
            in the diff or source, downgrade to PASS with a named observation instead.

              ❌ "validateEntitlements() is now called before CLAUDE_API_KEY is checked,
                 so the 503 test will fail." → Requires verifying actual call order. If
                 you cannot cite the lines proving that order, issue PASS.

              ✓ "Line 42 calls foo(), which at line 71 sets X to null; the assertion at
                 line 265 expects X to be non-null — that assertion will fail." → BLOCK.

              ✓ "The test fixture at line 48 does not set REVENUECAT_API_SECRET, but the
                 handler reads it at line 89 and returns early if absent — the test will
                 never reach the code path it claims to exercise." → BLOCK.

            When uncertain between BLOCK and PASS, default to PASS.

            You MUST complete ALL of the following steps in order:

            Step 1 — Write your review to /tmp/review.md

            Step 2 — Append the machine-readable verdict as the last line of the review:
              echo "" >> /tmp/review.md
              echo "VERDICT: PASS" >> /tmp/review.md
              # OR (if blocking issues found):
              echo "VERDICT: BLOCK" >> /tmp/review.md

            Step 3 — Post the review as a PR comment (the verdict line will be at the end):
              gh pr comment ${{ inputs.pr_number }} --body "$(cat /tmp/review.md)"

            Step 4 — Write the verdict to the verdict file:
              echo "VERDICT: PASS" > /tmp/review-verdict.txt
              # OR:
              echo "VERDICT: BLOCK" > /tmp/review-verdict.txt

            The verdict file (Step 4) is the primary signal read by CI. The verdict line
            appended to the comment (Step 2) is the fallback. Both must match.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Bash(echo *),Bash(cat *),Bash(tee *)"'

      - name: Check review verdict
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"

          # Escape hatch: [skip-claude-review: reason] in PR body bypasses enforcement
          PR_BODY=$(gh pr view "$PR_NUMBER" --json body -q .body 2>/dev/null || echo "")
          if echo "$PR_BODY" | grep -qF '[skip-claude-review]'; then
            echo "::notice::Claude Code Review enforcement skipped via [skip-claude-review] in PR body."
            echo "## Claude Code Review" >> "$GITHUB_STEP_SUMMARY"
            echo "**Verdict:** SKIPPED (override in PR body)" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi

          VERDICT_FILE="/tmp/review-verdict.txt"
          VERDICT=""

          if [ -f "$VERDICT_FILE" ]; then
            VERDICT=$(head -1 "$VERDICT_FILE")
            echo "Verdict source: file"
          else
            # Fallback: Claude sometimes includes the verdict in the comment body
            # instead of writing a separate file. Parse the most recent PR comment.
            echo "::warning::Verdict file not found — falling back to PR comment parsing."
            COMMENT=$(gh pr view "$PR_NUMBER" --json comments -q '.comments[-1].body' 2>/dev/null || echo "")
            if echo "$COMMENT" | grep -q "VERDICT: BLOCK"; then
              VERDICT="VERDICT: BLOCK"
              echo "Verdict source: PR comment (fallback)"
            elif echo "$COMMENT" | grep -q "VERDICT: PASS"; then
              VERDICT="VERDICT: PASS"
              echo "Verdict source: PR comment (fallback)"
            else
              echo "::warning::No verdict found in file or PR comment. Defaulting to PASS."
              echo "## Claude Code Review" >> "$GITHUB_STEP_SUMMARY"
              echo "**Verdict:** UNKNOWN (no verdict found — infrastructure failure or review incomplete)" >> "$GITHUB_STEP_SUMMARY"
              exit 0
            fi
          fi
          echo "Review verdict: $VERDICT"
          echo "## Claude Code Review" >> "$GITHUB_STEP_SUMMARY"

          if echo "$VERDICT" | grep -q "VERDICT: BLOCK"; then
            echo "**Verdict:** BLOCK" >> "$GITHUB_STEP_SUMMARY"
            echo "See the PR comment for details on the blocking issue(s)." >> "$GITHUB_STEP_SUMMARY"
            echo "To override after reviewing: add \`[skip-claude-review: reason]\` to the PR body." >> "$GITHUB_STEP_SUMMARY"
            echo "::error::Claude Code Review found blocking issues. See the PR comment for details. To override: add [skip-claude-review: reason] to the PR body."
            exit 1
          elif echo "$VERDICT" | grep -q "VERDICT: PASS"; then
            echo "**Verdict:** PASS" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          else
            echo "::warning::Unexpected verdict format: '$VERDICT'. Expected 'VERDICT: PASS' or 'VERDICT: BLOCK'. Defaulting to PASS."
            echo "**Verdict:** UNKNOWN (unexpected format — defaulting to PASS)" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
